<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Sterbestatistik/libs/highlight/github.min.css"> <link rel=stylesheet  href="/Sterbestatistik/css/franklin.css"> <link rel=stylesheet  href="/Sterbestatistik/css/latex.css"> <link href="/Sterbestatistik/css/vela.css" rel=stylesheet > <script src="/Sterbestatistik/libs/vela/jquery.min.js"></script> <link rel=icon  href="/Sterbestatistik/assets/favicon.png"> <title>Franklin Example | Vela</title> <div class=main-nav  id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>Mortalities 2020</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/Sterbestatistik/">Introduction</a> <li><a href="" class=has-arrow >Methods</a> <ul> <li><a href="/Sterbestatistik/dataprep/">Data</a> <li><a href="/Sterbestatistik/population/">Population</a> </ul> <li><a href="" class=has-arrow >Results</a> <ul> <li><a href="/Sterbestatistik/averageeffects_months/">Monthly</a> <li><a href="/Sterbestatistik/averageeffects/">Weekly</a> </ul> <li><a href="/Sterbestatistik/reflection/">Discussion</a> </ul> </nav> </div> <main id=panel > <div class="toggle-button hamburger hamburger--spin" style="position: fixed;z-index: 100;"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">Data preparation</h1> <hr> <div class=franklin-content > <div class=franklin-toc ><ol><li><a href="#sources">Sources</a><ol><li><a href="#mortality_statistics">Mortality statistics</a><li><a href="#population_statistics_pyramid">Population statistics &#40;pyramid&#41;</a></ol><li><a href="#a_tutorial_for_scientific_data_preparation_with_julia">A tutorial for <em>Scientific Data Preparation</em> with julia.</a><ol><li><a href="#population">Population</a><li><a href="#deaths_statistics_xlsx">Deaths statistics &#40;XLSX&#41;</a></ol></ol></div> <h2 id=sources ><a href="#sources" class=header-anchor >Sources</a></h2> <p>On this data prep example I express data lookup as julia keyword functions &#40;for providing value-conditions&#41;. Calling a function is convenient. Looking up values in tables is more tedious:</p> <h3 id=mortality_statistics ><a href="#mortality_statistics" class=header-anchor >Mortality statistics</a></h3> <p><strong>Goal</strong>: julia function to look up information in official data tables.</p> <pre><code class="julia hljs">deaths(year=<span class=hljs-number >2020</span>, cw=<span class=hljs-number >1</span>,
       geschlecht=<span class=hljs-string >&quot;Männlich&quot;</span>,
       alter=<span class=hljs-number >50</span>:<span class=hljs-number >60</span>)</code></pre> <p><strong>Source</strong>: <a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Tabellen/sonderauswertung-sterbefaelle.html">statistisches Bundesamt, &quot;Sterbefaelle-Lebenserwartung&quot;</a> &#40;Download <a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Tabellen/sonderauswertung-sterbefaelle.xlsx?__blob&#61;publicationFile">xlsx</a>&#41;,</p> <p>The death count data is an <strong>excel</strong> file with many tabs, the gender needs to be looked up by tab in the right one with data by calendar week. The age groups are 0-30, then in 5-year groups, then more than 95.</p> <h3 id=population_statistics_pyramid ><a href="#population_statistics_pyramid" class=header-anchor >Population statistics &#40;pyramid&#41;</a></h3> <p><strong>Goal</strong>: julia function to look up information in official data tables.</p> <pre><code class="julia hljs">population(year=<span class=hljs-number >2020</span>,
           geschlecht=<span class=hljs-string >&quot;Männlich&quot;</span>,
           alter=<span class=hljs-number >50</span>:<span class=hljs-number >60</span>)</code></pre> <p><strong>Source</strong>: <a href="https://www-genesis.destatis.de/genesis//online?operation&#61;table&amp;code&#61;12411-0006&amp;bypass&#61;true&amp;levelindex&#61;0&amp;levelid&#61;1612115589154#abreadcrumb">Statistisches Bundesamt, Tabelle 12411-0006</a></p> <p>The population statistics is a single comma separated values file, not simple, with some header information, and footer. The age groups here are by year, with aggregation above 85.</p> <p>CAVEAT:</p> <ul> <li><p>Alternative Data &#40;not used&#41;: <a href="https://service.destatis.de/bevoelkerungspyramide/index.html#&#33;y&#61;2018&amp;v&#61;2">Pyramid</a></p> <li><p><a href="https://www.destatis.de/DE/Themen/Gesellschaft-Umwelt/Bevoelkerung/Sterbefaelle-Lebenserwartung/Podcast/podcast-sterbefaelle.html">Podcast</a></p> </ul> <p><a href="/Sterbestatistik/averageeffects_months/">Read the results, or continue reading the details of data preparation:</a></p> <h2 id=a_tutorial_for_scientific_data_preparation_with_julia ><a href="#a_tutorial_for_scientific_data_preparation_with_julia" class=header-anchor >A tutorial for <em>Scientific Data Preparation</em> with julia.</a></h2> <p>Values need to be looked up for combinations of the following variables &#40;and calendar week&#41;: <pre><code class="julia hljs">jahre = <span class=hljs-number >2016</span>:<span class=hljs-number >2020</span>
geschlechter = [<span class=hljs-string >&quot;Männlich&quot;</span>, <span class=hljs-string >&quot;Weiblich&quot;</span>] <span class=hljs-comment ># , &quot;Insgesamt&quot;</span>
MAX=<span class=hljs-number >200</span>
altersgruppen_kw = [ <span class=hljs-number >0</span>:<span class=hljs-number >30</span>, [a:a+<span class=hljs-number >5</span> <span class=hljs-keyword >for</span> a <span class=hljs-keyword >in</span> <span class=hljs-number >30</span>:<span class=hljs-number >5</span>:<span class=hljs-number >80</span>]..., <span class=hljs-number >85</span>:MAX ];
altersgruppen_months = [ <span class=hljs-number >0</span>:<span class=hljs-number >15</span>, <span class=hljs-number >15</span>:<span class=hljs-number >30</span>, [a:a+<span class=hljs-number >5</span> <span class=hljs-keyword >for</span> a <span class=hljs-keyword >in</span> <span class=hljs-number >30</span>:<span class=hljs-number >5</span>:<span class=hljs-number >80</span>]..., <span class=hljs-number >85</span>:MAX ];
lcolors = [ <span class=hljs-string >&quot;#006298&quot;</span>, <span class=hljs-string >&quot;#A02438&quot;</span>, <span class=hljs-string >&quot;#449ADC&quot;</span>, <span class=hljs-string >&quot;#002B52&quot;</span>, <span class=hljs-string >&quot;#EC4A60&quot;</span> ]</code></pre></p> <p>As a human, I can lookup conveniently in the excel tables, but the comma separates values are tedious.</p> <p>The process of looking up data values needs to be formalized. Lookup needs to be expressed in terms of a programming language, here julia function calls. What julia function will be more simple?</p> <h3 id=population ><a href="#population" class=header-anchor >Population</a></h3> <p>The comma separated values &#40;CSV&#41; file would e.g. be loaded, trimmed and parsed <pre><code class="julia hljs"><span class=hljs-keyword >using</span> CSV, DataFrames, StringEncodings

p = CSV.File(
    open(read, <span class=hljs-string >&quot;data/12411-0006.csv&quot;</span>, <span class=hljs-string >enc&quot;ISO-8859-1&quot;</span>);
    skipto=<span class=hljs-number >9</span>, footerskip=<span class=hljs-number >4</span>,
    delim=<span class=hljs-string >&#x27;;&#x27;</span>, decimal=<span class=hljs-string >&#x27;,&#x27;</span>,
    dateformat=<span class=hljs-string >&quot;dd.mm.yyy&quot;</span>, 
    header=[<span class=hljs-string >&quot;Stichtag&quot;</span>, <span class=hljs-string >&quot;Altersgruppe&quot;</span>,<span class=hljs-string >&quot;Männlich&quot;</span>,<span class=hljs-string >&quot;Weiblich&quot;</span>,<span class=hljs-string >&quot;Insgesamt&quot;</span> ]) |&gt; DataFrame
p = p[p.Altersgruppe .!= <span class=hljs-string >&quot;Insgesamt&quot;</span>,:]

<span class=hljs-comment ># Let&#x27;s encode age ranges with UnitRange, and transform conveniently with CombinedParsers</span>
<span class=hljs-keyword >using</span> CombinedParsers
jahrp = Either(<span class=hljs-string >&quot;unter 1 Jahr&quot;</span> =&gt; <span class=hljs-number >0</span>:<span class=hljs-number >1</span>,
               map(a -&gt; a:a, 
                 Sequence(<span class=hljs-number >1</span>, CombinedParsers.Numeric(<span class=hljs-built_in >Int</span>),<span class=hljs-string >&quot;-Jährige&quot;</span>)),
               <span class=hljs-string >&quot;85 Jahre und mehr&quot;</span> =&gt; <span class=hljs-number >85</span>:MAX-<span class=hljs-number >1</span>,
               <span class=hljs-string >&quot;Insgesamt&quot;</span> =&gt; <span class=hljs-number >0</span>:MAX-<span class=hljs-number >1</span>)

p[!,<span class=hljs-string >&quot;Altersgruppe&quot;</span>] = [ parse(jahrp, v)
                        <span class=hljs-keyword >for</span> v <span class=hljs-keyword >in</span> p[!,<span class=hljs-number >2</span>] ];


<span class=hljs-keyword >using</span> Dates
<span class=hljs-string >&quot;better idea with Intervals?&quot;</span>
iseq(x,y) = [ e.start &gt;= y.start &amp;&amp; e.stop &lt; y.stop
              <span class=hljs-keyword >for</span> e <span class=hljs-keyword >in</span> x ]
<span class=hljs-keyword >function</span> population(; jahr, geschlecht=<span class=hljs-string >&quot;Insgesamt&quot;</span>, alter)
    <span class=hljs-comment ># @assert geschlecht in geschlechter</span>
    <span class=hljs-comment >## todo: boundary checks!</span>
    rows = (p[:,<span class=hljs-number >1</span>] .== Date(jahr-<span class=hljs-number >1</span>,<span class=hljs-number >12</span>,<span class=hljs-number >31</span>)) .&amp;
        iseq(p[:,<span class=hljs-number >2</span>], alter)
    sum(p[rows, geschlecht])
<span class=hljs-keyword >end</span>



poda = [ 
  ( alter = a,
    geschlecht=g, 
    jahr=j,
    N=population(alter=a, geschlecht=g, jahr=j)
<span class=hljs-comment >#    D=deaths(alter=a, geschlecht=g, jahr=j)</span>
  )
  <span class=hljs-keyword >for</span> a <span class=hljs-keyword >in</span> altersgruppen
  <span class=hljs-keyword >for</span> g <span class=hljs-keyword >in</span> geschlechter
  <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> jahre 
  ] |&gt; DataFrame;



N_sum = <span class=hljs-built_in >Dict</span>(
   r[<span class=hljs-number >1</span>] =&gt; r[<span class=hljs-number >2</span>] 
   <span class=hljs-keyword >for</span> r <span class=hljs-keyword >in</span> eachrow(
              combine(groupby(poda, :jahr), 
                      :N=&gt;sum)))


<span class=hljs-keyword >using</span> Statistics
<span class=hljs-keyword >using</span> StatsPlots
<span class=hljs-keyword >using</span> StatsPlots.PlotMeasures
poda[:,:P] = poda.N ./ [ N_sum[j] <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> poda.jahr ]
poda[:,:cell] = collect(zip(poda.alter,poda.geschlecht))

PAG_mean = <span class=hljs-keyword >let</span> tmp = combine(groupby(poda, :cell), 
                  :P=&gt;mean)
    <span class=hljs-built_in >Dict</span>([ r[<span class=hljs-number >1</span>] =&gt; r[<span class=hljs-number >2</span>] 
           <span class=hljs-keyword >for</span> r <span class=hljs-keyword >in</span> eachrow(tmp)
	   ])
<span class=hljs-keyword >end</span></code></pre></p> <p>This is not too painful and straight forward. The aggregation with <code>UnitRange</code> is convenient but can be further improved.</p> <h3 id=deaths_statistics_xlsx ><a href="#deaths_statistics_xlsx" class=header-anchor >Deaths statistics &#40;XLSX&#41;</a></h3> <p>But now with the excel it is funny. <pre><code class="julia hljs"><span class=hljs-keyword >using</span> XLSX
d = XLSX.readxlsx(<span class=hljs-string >&quot;data/sonderauswertung-sterbefaelle.xlsx&quot;</span>)
<span class=hljs-keyword >function</span> deaths(; alter::<span class=hljs-built_in >UnitRange</span>, geschlecht, jahr, kw=<span class=hljs-literal >missing</span>, month=<span class=hljs-literal >missing</span>)
    <span class=hljs-meta >@assert</span> geschlecht <span class=hljs-keyword >in</span> geschlechter
    <span class=hljs-keyword >if</span> alter==<span class=hljs-number >85</span>:MAX
        <span class=hljs-keyword >return</span> deaths(;alter=<span class=hljs-number >85</span>:<span class=hljs-number >90</span>,geschlecht=geschlecht, jahr=jahr, kw=kw, month=month)+
            deaths(;alter=<span class=hljs-number >90</span>:<span class=hljs-number >95</span>,geschlecht=geschlecht, jahr=jahr, kw=kw, month=month)+
            deaths(;alter=<span class=hljs-number >95</span>:MAX,geschlecht=geschlecht, jahr=jahr, kw=kw, month=month)
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >if</span> kw === <span class=hljs-literal >missing</span>
        <span class=hljs-keyword >if</span> month === <span class=hljs-literal >missing</span> 
	    <span class=hljs-keyword >return</span> sum(<span class=hljs-built_in >Int</span>[ deaths(;alter=alter,geschlecht=geschlecht, jahr=jahr, month=i)
                            <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >12</span>
                            <span class=hljs-keyword >if</span> deaths(;alter=alter,geschlecht=geschlecht, jahr=jahr, kw=i) <span class=hljs-keyword >isa</span> <span class=hljs-built_in >Integer</span>])
        <span class=hljs-keyword >else</span>
            <span class=hljs-comment ># skipping 11 lines,</span>
            zeile = <span class=hljs-number >11</span> +
                <span class=hljs-comment ># 16 lines blocks for years,</span>
                (<span class=hljs-number >2020</span>-jahr)*<span class=hljs-number >17</span> + 
                <span class=hljs-comment ># 5 year steps beginning age 30</span>
                <span class=hljs-keyword >if</span> alter.start == <span class=hljs-number >0</span>
                    <span class=hljs-number >0</span>
                <span class=hljs-keyword >elseif</span> alter.start == <span class=hljs-number >15</span>
                    <span class=hljs-number >1</span>
                <span class=hljs-keyword >else</span>
                    <span class=hljs-number >1</span> + max(<span class=hljs-number >0</span>, (alter.start-<span class=hljs-number >25</span>)/<span class=hljs-number >5</span>)
                <span class=hljs-keyword >end</span>
            <span class=hljs-comment >## look up gender tab</span>
            tab = d[<span class=hljs-string >&quot;D_2016-2020_Monate_AG_<span class=hljs-variable >$geschlecht</span>&quot;</span>]
            <span class=hljs-comment ># and check in cw column, skipping first 3</span>
            r = tab[convert(<span class=hljs-built_in >Int</span>,zeile), month+<span class=hljs-number >3</span>]
	    r <span class=hljs-keyword >isa</span> <span class=hljs-built_in >Integer</span> ? r : <span class=hljs-number >0</span>
	<span class=hljs-keyword >end</span>
    <span class=hljs-keyword >else</span>
        <span class=hljs-keyword >if</span> month !== <span class=hljs-literal >missing</span>
            error(<span class=hljs-string >&quot;proveide either month or calendar week, but not both&quot;</span>)
        <span class=hljs-keyword >end</span>
        <span class=hljs-comment ># @assert alter isa UnitRange &amp;&amp; alter.stop-alter.start==5 &amp;&amp; alter.start&lt;=95</span>
        <span class=hljs-keyword >if</span> alter.start &gt;= <span class=hljs-number >95</span>
	    <span class=hljs-comment >#@warn &quot;alter&quot; alter</span>
            alter = <span class=hljs-number >95</span>:MAX
        <span class=hljs-keyword >end</span>    
        <span class=hljs-keyword >if</span> alter.stop &lt;= <span class=hljs-number >30</span>
	    <span class=hljs-comment >#@warn &quot;alter&quot; alter</span>
            alter = <span class=hljs-number >0</span>:<span class=hljs-number >30</span>
        <span class=hljs-keyword >end</span>
        <span class=hljs-comment ># skipping 11 lines,</span>
        zeile = <span class=hljs-number >11</span> +
            <span class=hljs-comment ># 16 lines blocks for years,</span>
            (<span class=hljs-number >2020</span>-jahr)*<span class=hljs-number >16</span> + 
            <span class=hljs-comment ># 5 year steps beginning age 30</span>
            max(<span class=hljs-number >0</span>, (alter.start-<span class=hljs-number >25</span>)/<span class=hljs-number >5</span>)
        <span class=hljs-comment >## look up gender tab</span>
        tab = d[<span class=hljs-string >&quot;D_2016_2020_KW_AG_<span class=hljs-variable >$geschlecht</span>&quot;</span>]
        <span class=hljs-comment ># and check in cw column, skipping first 3</span>
        r = tab[convert(<span class=hljs-built_in >Int</span>,zeile), kw+<span class=hljs-number >3</span>]
	r <span class=hljs-keyword >isa</span> <span class=hljs-built_in >Integer</span> ? r : <span class=hljs-number >0</span>
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre></p> <p>I am sure there is a better way to do this.</p> <p>Example tuple for testing:</p> <pre><code class="julia hljs">f(;kw=<span class=hljs-literal >missing</span>, args...) = (N=population(; args...), D=deaths(; kw=kw,args...))

<span class=hljs-meta >@show</span> f(alter=<span class=hljs-number >0</span>:<span class=hljs-number >30</span>, geschlecht=<span class=hljs-string >&quot;Männlich&quot;</span>, jahr=<span class=hljs-number >2020</span>, kw=<span class=hljs-number >1</span>)
<span class=hljs-meta >@show</span> f(alter=<span class=hljs-number >30</span>:<span class=hljs-number >35</span>, geschlecht=<span class=hljs-string >&quot;Männlich&quot;</span>, jahr=<span class=hljs-number >2020</span>)</code></pre> <pre><code class="plaintext hljs">LoadError: UndefVarError: altersgruppen not defined
in expression starting at /home/runner/work/Sterbestatistik/Sterbestatistik/_assets/scripts/population.jl:37
</code></pre> <div class=page-foot > <div class=copyright > &copy; Dr. Gregor Kappler. Last modified: February 22, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </main> <script src="/Sterbestatistik/libs/vela/metisMenu.min.js"></script> <script src="/Sterbestatistik/libs/vela/slideout.min.js"></script>